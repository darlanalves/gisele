!function(e){"use strict";function t(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),u=function(){function e(){r(this,e)}return o(e,[{key:"toString",value:function(){return this.constructor.__name__}},{key:"toJSON",value:function(){return e.helpers.toJSON(this)}}],[{key:"new",value:function(t){return e.helpers.create(t)}},{key:"create",value:function(t){return e.helpers.create(t)}}]),e}();u.helpers={toJSON:function(e){function t(e){var t=e.name,n=void 0;t in r&&(n=u.helpers.fieldToJSON(e,r[t])),void 0!==n&&(i[t]=n)}var n=[e.$$.data,e.$$.changed||{}],r={},i={};return n.forEach(function(e){Object.keys(e).forEach(function(t){r[t]=e[t]})}),u.helpers.iterateFields(e,t),i},fieldToJSON:function(e,t){return e.isArray&&Array.isArray(t)?t.map(e.serialize,e):e.serialize(t)},isModel:function(e){return e instanceof u},create:function(e){if("object"!==("undefined"==typeof e?"undefined":i(e)))throw new Error("Invalid model configuration");var t,n,r;e.fields?(t=e.name||"Model",n=e.fields||{},r=e.methods):(t="Model",n=e);var o=function(e){u.helpers.initialize(this,o),u.helpers.applyDefaultValues(this,o),u.helpers.applyValues(this,e)},a=Object.keys(n),s=a.map(function(e){return u.helpers.createField(e,n[e],o)}),f={name:t,fields:s,customMethods:r};return u.constructors.forEach(function(e){e(o,f)}),o},defineProperty:function(e,t){var n=t.name,r=function(){return e.$$.get(n)},i=u.helpers.noop;t.readOnly||(i=function(r){r=t.parseValue(r),e.$$.set(n,r)});var o={enumerable:!0,get:r,set:i};Object.defineProperty(e,n,o)},initialize:function(e,t){var n=t.__fields__;n.forEach(function(t){u.helpers.defineProperty(e,t)}),u.initializers.forEach(function(n){n(e,t)})},noop:function(){},createField:function(e,t,n){if(!t)throw new Error("Invalid field config",t);"self"===t?t=n:"self"===t.type&&(t.type=n);var r="undefined"==typeof t?"undefined":i(t),o=t;if("function"===r&&(o={type:o}),o.name||(o.name=e),"function"!=typeof o.type)throw new Error("Invalid field type",o.type);return s.create(o)},applyChanges:function(e,t,n){"object"===("undefined"==typeof t?"undefined":i(t))&&t?Object.keys(t).forEach(function(n){return e[n]=t[n]}):e[t]=n},applyDefaultValues:function(e){function t(e){"default"in e&&this.$$.setPersistent(e.name,e.default)}u.helpers.iterateFields(e,t)},applyValues:function(e,t){function n(e){var n=e.name;if(n in t){var r=e.parseValue(t[n]);this.$$.setPersistent(n,r)}}t&&"object"===("undefined"==typeof t?"undefined":i(t))&&u.helpers.iterateFields(e,n)},iterateFields:function(e,t){return e.constructor.__fields__.map(t,e)}},u.initializers=[],u.initializers.push(function(e,t){var n=a.create(t);Object.defineProperty(e,"$$",{enumerable:!1,value:n})}),u.initializers.push(function(e){Object.defineProperty(e,"$$dirty",{enumerable:!1,set:u.helpers.noop,get:function(){return e.$$.changed!==!1}})}),u.constructors=[],u.constructors.push(function(e){var t=Object.create(u.prototype);t.constructor=e,e.prototype=t}),u.constructors.push(function(e,t){var n=t.name,r=t.fields,i={__fields__:r,__name__:n};Object.keys(i).forEach(function(t){Object.defineProperty(e,t,{value:i[t],writable:!1})})}),u.constructors.push(function(e,t){var n=t.customMethods;if(n){var r=t.fields.map(function(e){return e.name}),i=Object.keys(n);i.forEach(function(t){if(-1!==r.indexOf(t))throw new Error("Cannot override field "+t+" with a custom method of same name");e.prototype[t]=n[t]})}});var a=function(){function e(){r(this,e)}return o(e,[{key:"setPersistent",value:function(e,t){u.helpers.applyChanges(this.data,e,t)}},{key:"set",value:function(e,t){return this.changed||(this.changed={}),u.helpers.applyChanges(this.changed,e,t),this}},{key:"get",value:function(e){return this.changed&&e in this.changed?this.changed[e]:this.data[e]}},{key:"commit",value:function(){u.helpers.applyChanges(this.data,this.changed),this.changed=!1}},{key:"rollback",value:function(){this.changed=!1}}]),e}();u.fn=a.prototype,u.fn.changed=!1,a.create=function(e){var t=new a;return t.data={},t.Model=e,t};var s=function(){function e(t){var n=this;if(r(this,e),!t)throw new Error("Invalid field config");Object.keys(t).forEach(function(e){return n[e]=t[e]})}return o(e,[{key:"parseValue",value:function(e){return this.isArray?this.parseArray(e):this.parse(e)}},{key:"parseArray",value:function(e){return Array.isArray(e)?e.map(this.parse,this):null}},{key:"parse",value:function(e){return e}},{key:"serialize",value:function(e){return e}}],[{key:"create",value:function(t){var n=t.type,r=e.registry.get(n)||y;return new r(t)}}]),e}();s.registry=new Map;var f=function(e){function u(){return r(this,u),t(this,Object.getPrototypeOf(u).apply(this,arguments))}return n(u,e),o(u,[{key:"parse",value:function(e){return String(void 0!==e?e:"").trim()}},{key:"serialize",value:function(e){return"object"!==("undefined"==typeof e?"undefined":i(e))?String(e):void 0}}]),u}(s),c=function(e){function i(){return r(this,i),t(this,Object.getPrototypeOf(i).apply(this,arguments))}return n(i,e),o(i,[{key:"parse",value:function(e){return!!e}}]),i}(s),l=function(e){function i(){return r(this,i),t(this,Object.getPrototypeOf(i).apply(this,arguments))}return n(i,e),o(i,[{key:"parse",value:function(e){return e&&Number(e)||0}}]),i}(s),p=function(e){function i(){return r(this,i),t(this,Object.getPrototypeOf(i).apply(this,arguments))}return n(i,e),o(i,[{key:"parse",value:function(e){if(isFinite(e))return new Date(e);if("string"==typeof e){var t=Date.parse(e);return isFinite(t)?new Date(t):null}return null}},{key:"serialize",value:function(e){return e instanceof Date?e.toJSON():void 0}}]),i}(s),y=function(e){function i(){return r(this,i),t(this,Object.getPrototypeOf(i).apply(this,arguments))}return n(i,e),o(i,[{key:"parse",value:function(e){return null!==e?new this.type(e):null}},{key:"serialize",value:function(e){return e&&"function"==typeof e.toJSON?e.toJSON():e}}]),i}(s);s.add=s.registry.set.bind(s.registry),s.get=s.registry.get.bind(s.registry),s.registry.set(String,f),s.registry.set(Number,l),s.registry.set(Boolean,c),s.registry.set(Date,p),s.Generic=y;var h=function(e){function u(){return r(this,u),t(this,Object.getPrototypeOf(u).apply(this,arguments))}return n(u,e),o(u,[{key:"parse",value:function(e){var t=this.type;return e&&"object"===("undefined"==typeof e?"undefined":i(e))?e instanceof t?e:new t(e):null}},{key:"serialize",value:function(e){return e&&e instanceof this.type?e.toJSON():null}}]),u}(s),d={Model:u,Field:s,RelationField:h};"function"==typeof define&&define.amd?define(function(){return d}):"undefined"!=typeof module&&module.exports?(module.exports.Model=u,module.exports.Field=s,module.exports.RelationField=h):e.Gisele=d}(this);